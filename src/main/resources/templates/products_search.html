<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Admin - Search Products</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <style>
        :root{--sidebar:#111827; --accent:#2563eb; --muted:#6b7280; --card:#fff;}
        body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f4f6f8;color:#111}
        .layout{display:flex;min-height:100vh}
        .sidebar{width:220px;background:var(--sidebar);color:#fff;display:flex;flex-direction:column}
        .brand{padding:18px;font-weight:700;border-bottom:1px solid rgba(255,255,255,0.06)}
        .nav{padding:12px;flex:1}
        .nav a{display:block;color:rgba(255,255,255,0.95);text-decoration:none;padding:8px 12px;border-radius:6px;margin-bottom:6px}
        .nav a:hover{background:rgba(255,255,255,0.04)}
        .content-wrap{flex:1;display:flex;flex-direction:column}
        .topbar{background:#fff;padding:12px 20px;border-bottom:1px solid #e6e9ee;display:flex;align-items:center;justify-content:space-between}
        .page{padding:20px;max-width:1100px;margin:18px auto;width:100%}
        .card{background:var(--card);padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
        .muted{color:var(--muted);}
        input[type="search"]{
            width:100%;padding:10px;font-size:16px;
            border:1px solid #ddd;border-radius:6px;
        }
        .spinner{
            width:18px;height:18px;border-radius:50%;
            border:3px solid rgba(0,0,0,0.2);
            border-top-color:black;animation:spin 1s linear infinite;
            display:none;margin-top:8px;
        }
        [hx-indicator].htmx-request .spinner{display:inline-block;}
        @keyframes spin{to{transform:rotate(360deg);}}
        table{
            width:100%;border-collapse:collapse;margin-top:16px;
        }
        th, td{
            border:1px solid #ccc;padding:10px;text-align:left;
        }
        th{background:#f4f4f4;}
        button{
            padding:6px 12px;border:none;border-radius:6px;
            background:var(--accent);color:#fff;cursor:pointer;
        }
        .delete-btn{background:#ef4444;}
        @media(max-width:800px){ .sidebar{display:none;} }
    </style>
</head>
<body>

<div class="layout">
    <aside class="sidebar">
        <div class="brand">Admin Panel</div>
        <nav class="nav">
            <a href="/" th:href="@{/}">Home</a>
            <a href="/products" th:href="@{/products}">Products</a>
        </nav>
    </aside>

    <div class="content-wrap">
        <div class="topbar">
            <div><strong>Search Products</strong></div>
            <div class="muted">Logged in as Admin</div>
        </div>

        <main class="page">
            <div class="card">

                <h1>Search Products</h1>

                <input
                        id="search-id"
                        name="title"
                        placeholder="Type product title..."
                        type="search"
                        hx-get="/products/search/results"
                        hx-trigger="keyup changed delay:300ms"
                        hx-target="#search-results"
                        hx-swap="outerHTML"
                        autocomplete="off"
                        hx-indicator="#spinner"
                />

                <div id="spinner" class="spinner"></div>

                <div id="search-results">
                    <p class="muted">Start typing to search...</p>
                </div>

                <div th:fragment="searchResults">
                    <div id="search-results">

                        <div th:if="${products != null and not #lists.isEmpty(products)}">
                            <table>
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Handle</th>
                                    <th>Edit</th>
                                    <th>Delete</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="p : ${products}">
                                    <td th:text="${p.id}"></td>
                                    <td th:text="${p.title}"></td>
                                    <td th:text="${p.handle}"></td>
                                    <td>
                                        <button type="button"
                                                th:onclick="'window.location.href=\'/products/' + ${p.id} + '\';'">
                                            Update
                                        </button>
                                    </td>
                                    <td>
                                        <button type="button"
                                                class="delete-btn"
                                                th:attr="data-id=${p.id}, data-title=${p.title}"
                                                onclick="openDeleteDialog(this)">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div th:if="${products != null and #lists.isEmpty(products)}"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<!-- Delete dialog -->
<dialog id="confirmDeleteDialog">
    <h3>Confirm Delete</h3>
    <p id="confirmDeleteMsg">Are you sure you want to delete this?</p>
    <div style="margin-top:12px;">
        <button type="button" onclick="closeDeleteDialog()">Cancel</button>
        <button id="confirmDeleteBtn" type="button" style="background:#ef4444;color:white">Delete</button>
    </div>
</dialog>

<script>
    function openDeleteDialog(btn) {
        const id = btn.getAttribute('data-id');
        const title = btn.getAttribute('data-title') || id;
        const dialog = document.getElementById('confirmDeleteDialog');
        const msg = document.getElementById('confirmDeleteMsg');
        const confirmBtn = document.getElementById('confirmDeleteBtn');

        msg.textContent = `Are you sure you want to delete product "${title}" (ID: ${id})?`;

        const tr = btn.closest('tr');
        if (tr && !tr.id) tr.id = 'row-' + id;

        confirmBtn.setAttribute('data-delete-id', id);

        if (dialog.showModal) dialog.showModal();
        else dialog.setAttribute('open', '');
    }

    function closeDeleteDialog() {
        const dialog = document.getElementById('confirmDeleteDialog');
        try { dialog.close(); } catch(e) { dialog.removeAttribute('open'); }
    }

    function checkEmptyTable() {
        const wrapper = document.getElementById('search-results');
        if (!wrapper) return;
        const tbody = wrapper.querySelector('table tbody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));

        if (rows.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.setAttribute('colspan', '5');
            td.className = 'muted';
            td.textContent = 'No products found.';
            tr.appendChild(td);
            tbody.appendChild(tr);
        } else {
            rows.forEach(r => {
                const td = r.querySelector('td');
                if (td && td.colSpan === 5 && td.classList.contains('muted') && rows.length > 1) {
                    r.remove();
                }
            });
        }
    }

    document.addEventListener('click', function(e) {
        const el = e.target;
        if (!el || el.id !== 'confirmDeleteBtn') return;

        e.preventDefault(); e.stopPropagation();

        const id = el.getAttribute('data-delete-id');
        const url = `/products/${id}`;
        const rowSelector = `#row-${id}`;

        if (window.htmx) {
            htmx.ajax('DELETE', url, { target: rowSelector, swap: 'outerHTML' });
            setTimeout(closeDeleteDialog, 200);
            setTimeout(checkEmptyTable, 300);
            return;
        }

        fetch(url, { method: 'DELETE', credentials: 'same-origin' })
            .then(r => {
                if (r.ok) {
                    document.querySelector(rowSelector)?.remove();
                    closeDeleteDialog();
                    checkEmptyTable();
                } else {
                    r.text().then(text => alert('Delete failed: ' + r.status + '\n' + text));
                }
            })
            .catch(err => alert('Delete error: ' + err));
    });

    document.addEventListener('DOMContentLoaded', checkEmptyTable);
    document.body.addEventListener('htmx:afterSwap', e => {
        if (e.detail.target.id === 'search-results') setTimeout(checkEmptyTable, 50);
    });
</script>

</body>
</html>
