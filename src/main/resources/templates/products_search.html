<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Admin - Search Products</title>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>

    <!-- ✅ Web Awesome Theme (includes Design Tokens) -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@awesome.me/webawesome@3.0.0/dist-cdn/styles/themes/default.css">

    <!-- ✅ Web Awesome Components Loader -->
    <script type="module"
            src="https://cdn.jsdelivr.net/npm/@awesome.me/webawesome@3.0.0/dist-cdn/webawesome.loader.js">
    </script>

    <!-- Global Admin CSS -->
    <link rel="stylesheet" th:href="@{/admin_styles.css}">
</head>
<body>

<div class="layout">
    <aside class="sidebar"
           th:replace="common/sidebar :: sidebar">
    </aside>

    <div class="content-wrap">
        <div class="topbar">
            <div><strong>Search Products</strong></div>
            <div class="muted">Logged in as Admin</div>
        </div>

        <main class="page">
            <div class="card">

                <h1>Search Products</h1>

                <input
                        id="search-id"
                        name="title"
                        placeholder="Type product title..."
                        type="search"
                        hx-get="/products/search/results"
                        hx-trigger="keyup changed delay:300ms"
                        hx-target="#search-results"
                        hx-swap="outerHTML"
                        autocomplete="off"
                        hx-indicator="#spinner"
                />

                <div id="spinner" class="spinner"></div>

                <div id="search-results">
                    <p class="muted">Start typing to search...</p>
                </div>

                <div th:fragment="searchResults">
                    <div id="search-results">
                        <!-- (unchanged table fragment content retained) -->
                        <div th:if="${products != null and not #lists.isEmpty(products)}" class="wa-table-wrapper">
                            <table class="wa-table">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Handle</th>
                                    <th>Vendor</th>
                                    <th>Product Type</th>
                                    <th>Published At</th>
                                    <th>Created At</th>
                                    <th>Updated At</th>
                                    <th>Actions</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="p : ${products}">
                                    <td th:text="${p.id}"></td>
                                    <td th:text="${p.title}"></td>
                                    <td th:text="${p.handle}"></td>

                                    <td th:text="${p.vendor}">—</td>
                                    <td th:text="${p.productType}">—</td>

                                    <td th:text="${#temporals.format(p.publishedAt, 'yyyy-MM-dd HH:mm')}">—</td>
                                    <td th:text="${#temporals.format(p.createdAt, 'yyyy-MM-dd HH:mm')}">—</td>
                                    <td th:text="${#temporals.format(p.updatedAt, 'yyyy-MM-dd HH:mm')}">—</td>
                                    <td>
                                        <wa-button type="button" variant="success" size="small"
                                                   th:onclick="'window.location.href=\'/products/' + ${p.id} + '\';'">
                                            <wa-icon name="pencil"></wa-icon>
                                        </wa-button>

                                    </td>
                                    <td>
                                        <!-- Delete opens dialog -->
                                        <wa-button type="button" variant="danger" size="small"
                                                   style="margin-left:8px;background:#ef4444"
                                                   class="delete-btn"
                                                   th:attr="data-id=${p.id}, data-title=${p.title}"
                                                   onclick="openDeleteDialog(this)">
                                            <wa-icon name="trash"></wa-icon>
                                        </wa-button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div th:if="${products != null and #lists.isEmpty(products)}"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<!-- Delete dialog (kept same behaviour) -->
<dialog id="confirmDeleteDialog">
    <h3>Confirm Delete</h3>
    <p id="confirmDeleteMsg">Are you sure you want to delete this?</p>
    <div style="margin-top:12px;">
        <wa-button onclick="closeDeleteDialog()">Cancel</wa-button>
        <wa-button id="confirmDeleteBtn" variant="danger">Delete</wa-button>
    </div>
</dialog>

<script>
    function openDeleteDialog(btn) {
        const id = btn.getAttribute('data-id');
        const title = btn.getAttribute('data-title') || id;
        const dialog = document.getElementById('confirmDeleteDialog');
        const msg = document.getElementById('confirmDeleteMsg');
        const confirmBtn = document.getElementById('confirmDeleteBtn');

        msg.textContent = `Are you sure you want to delete product "${title}" (ID: ${id})?`;

        const tr = btn.closest('tr');
        if (tr && !tr.id) tr.id = 'row-' + id;

        confirmBtn.setAttribute('data-delete-id', id);

        if (dialog.showModal) dialog.showModal();
        else dialog.setAttribute('open', '');
    }

    function closeDeleteDialog() {
        const dialog = document.getElementById('confirmDeleteDialog');
        try { dialog.close(); } catch(e) { dialog.removeAttribute('open'); }
    }

    function checkEmptyTable() {
        const wrapper = document.getElementById('search-results');
        if (!wrapper) return;
        const tbody = wrapper.querySelector('table tbody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));

        if (rows.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.setAttribute('colspan', '5');
            td.className = 'muted';
            td.textContent = 'No products found.';
            tr.appendChild(td);
            tbody.appendChild(tr);
        } else {
            rows.forEach(r => {
                const td = r.querySelector('td');
                if (td && td.colSpan === 5 && td.classList.contains('muted') && rows.length > 1) {
                    r.remove();
                }
            });
        }
    }

    document.addEventListener('click', function(e) {
        const el = e.target;
        if (!el || el.id !== 'confirmDeleteBtn') return;

        e.preventDefault(); e.stopPropagation();

        const id = el.getAttribute('data-delete-id');
        const url = `/products/${id}`;
        const rowSelector = `#row-${id}`;

        if (window.htmx) {
            htmx.ajax('DELETE', url, { target: rowSelector, swap: 'outerHTML' });
            setTimeout(closeDeleteDialog, 200);
            setTimeout(checkEmptyTable, 300);
            return;
        }

        fetch(url, { method: 'DELETE', credentials: 'same-origin' })
            .then(r => {
                if (r.ok) {
                    document.querySelector(rowSelector)?.remove();
                    closeDeleteDialog();
                    checkEmptyTable();
                } else {
                    r.text().then(text => alert('Delete failed: ' + r.status + '\n' + text));
                }
            })
            .catch(err => alert('Delete error: ' + err));
    });

    document.addEventListener('DOMContentLoaded', checkEmptyTable);
    document.body.addEventListener('htmx:afterSwap', e => {
        if (e.detail.target.id === 'search-results') setTimeout(checkEmptyTable, 50);
    });
</script>

</body>
</html>
