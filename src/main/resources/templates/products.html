<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Admin — Products</title>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>

    <!-- (optional) WebAwesome — remove if you don't use it -->
    <script type="module" src="https://esm.run/@webawesome/components"></script>
    <link rel="stylesheet" href="https://esm.run/@webawesome/components/dist/webawesome/webawesome.css">

    <!-- Global Admin CSS -->
    <link rel="stylesheet" th:href="@{/admin_styles.css}">
</head>
<body>

<div class="layout">
    <aside class="sidebar"
           th:replace="common/sidebar :: sidebar">
    </aside>

    <div class="content-wrap">
        <div class="topbar">
            <div><strong>Products</strong></div>
            <div class="muted">Admin</div>
        </div>

        <main class="page">
            <div class="card">
                <!-- Controls -->
                <div class="controls">
                    <button hx-get="/products/list" hx-target="#products-table" hx-swap="outerHTML" id="load-btn">Load products</button>
                    <button type="button" onclick="window.location.href='/products/search'">Search</button>
                </div>

                <!-- Table container -->
                <div id="products-table">
                    <p class="muted">Click "Load products" to load products.</p>
                </div>

                <!-- HTMX fragment (server returns this fragment) -->
                <div th:fragment="table">
                    <div id="products-table">
                        <div th:if="${products != null and not #lists.isEmpty(products)}">

                            <!-- Add form above table -->
                            <div style="margin-bottom:12px;">
                                <form id="add-product-form"
                                      th:action="@{/products}"
                                      method="post"
                                      hx-post="/products"
                                      hx-target="#products-table"
                                      hx-swap="outerHTML">
                                    <label>Title:
                                        <input type="text" name="title" required/>
                                    </label>
                                    <label style="margin-left:12px;">Handle:
                                        <input type="text" name="handle"/>
                                    </label>
                                    <button type="submit" style="margin-left:12px;">Add Product</button>
                                </form>
                            </div>

                            <table>
                                <thead>
                                <tr>
                                    <th style="width:140px">ID</th>
                                    <th>Title</th>
                                    <th>Handle</th>
                                    <th style="width:200px">Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="p : ${products}" th:id="'row-' + ${p.id}">
                                    <td th:text="${p.id}"></td>
                                    <td th:text="${p.title}"></td>
                                    <td th:text="${p.handle}"></td>
                                    <td>
                                        <!-- Update as button -->
                                        <button type="button"
                                                th:onclick="'window.location.href=\'/products/' + ${p.id} + '\';'">
                                            Update
                                        </button>

                                        <!-- Delete opens dialog -->
                                        <button type="button"
                                                style="margin-left:8px;background:#ef4444"
                                                class="delete-btn"
                                                th:attr="data-id=${p.id}, data-title=${p.title}"
                                                onclick="openDeleteDialog(this)">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>

                        </div>

                        <!-- If products is empty ⇒ return empty (server fragment can return nothing) -->
                        <div th:if="${products != null and #lists.isEmpty(products)}"></div>
                    </div>
                </div>
                <!-- /fragment -->

            </div> <!-- /card -->
        </main>
    </div>
</div>

<!-- Delete confirmation dialog -->
<dialog id="confirmDeleteDialog">
    <h3>Confirm Delete</h3>
    <p id="confirmDeleteMsg">Are you sure you want to delete this?</p>
    <div style="margin-top:12px;">
        <button type="button" onclick="closeDeleteDialog()">Cancel</button>
        <button id="confirmDeleteBtn" type="button" style="background:#ef4444">Delete</button>
    </div>
</dialog>

<script>
    // Reset add product form after table is swapped in
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        const target = evt.detail && evt.detail.target;
        if (target && target.id === 'products-table') {
            const form = document.getElementById('add-product-form');
            if (form) form.reset();
        }
        setTimeout(checkEmptyTable, 0);
    });

    function openDeleteDialog(btn) {
        const id = btn.getAttribute('data-id');
        const title = btn.getAttribute('data-title') || id;
        const dialog = document.getElementById('confirmDeleteDialog');
        const msg = document.getElementById('confirmDeleteMsg');
        const confirmBtn = document.getElementById('confirmDeleteBtn');

        msg.textContent = `Are you sure you want to delete product "${title}" (ID: ${id})?`;
        confirmBtn.setAttribute('data-delete-id', id);
        dialog.showModal();
    }

    function closeDeleteDialog() {
        const dialog = document.getElementById('confirmDeleteDialog');
        if (dialog) { try { dialog.close(); } catch(e) {} }
    }

    function checkEmptyTable() {
        const wrapper = document.getElementById('products-table');
        if (!wrapper) return;
        const tbody = wrapper.querySelector('table tbody');
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr'));
        // If no real rows, insert a placeholder row
        if (rows.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.setAttribute('colspan', '4');
            td.className = 'muted';
            td.textContent = 'No products available.';
            tr.appendChild(td);
            tbody.appendChild(tr);
        } else {
            // remove placeholder if extra real rows exist
            rows.forEach(r => {
                const firstTd = r.querySelector('td');
                if (firstTd && firstTd.colSpan === 4 && firstTd.classList.contains('muted') && rows.length > 1) {
                    r.remove();
                }
            });
        }
    }

    // Delete confirm handler: prefer HTMX, fallback to fetch()
    document.addEventListener('click', function(e) {
        const el = e.target;
        if (!el || el.id !== 'confirmDeleteBtn') return;

        e.preventDefault(); e.stopPropagation();
        const id = el.getAttribute('data-delete-id');
        if (!id) return;
        const url = `/products/${id}`;
        const rowSelector = `#row-${id}`;

        if (window.htmx && typeof htmx.ajax === 'function') {
            htmx.ajax('DELETE', url, { target: rowSelector, swap: 'outerHTML' });
            setTimeout(() => closeDeleteDialog(), 200);
            setTimeout(() => { setTimeout(checkEmptyTable, 200); }, 300);
            return;
        }

        // fallback
        fetch(url, { method: 'DELETE', credentials: 'same-origin' })
            .then(r => {
                if (r.ok) {
                    document.querySelector(rowSelector)?.remove();
                    closeDeleteDialog();
                    checkEmptyTable();
                } else {
                    r.text().then(text => alert('Delete failed: ' + r.status + '\n' + text));
                }
            })
            .catch(err => alert('Delete error: ' + err));
    });

    document.addEventListener('DOMContentLoaded', function() { checkEmptyTable(); });
</script>

</body>
</html>
