<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Products</title>

    <script src="https://unpkg.com/htmx.org@1.9.2"></script>

    <script type="module" src="https://esm.run/@webawesome/components"></script>
    <link rel="stylesheet" href="https://esm.run/@webawesome/components/dist/webawesome/webawesome.css">

    <style>
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; }
        th { background: #f4f4f4; }
        .add-form { margin-top: 20px; }
        dialog { padding: 20px; border-radius: 8px; border: 1px solid #aaa; }
        .muted { color: #666; padding: 8px 0; }
    </style>
</head>

<body>

<h1>Products</h1>

<!-- Load button -->
<button hx-get="/products/list"
        hx-target="#products-table"
        hx-swap="outerHTML"
        id="load-btn">
    Load products
</button>

<!-- NEW: Search Products button -->
<button variant="secondary"
        onclick="window.location.href='/products/search'">
    Search
</button>

<!-- Initial placeholder -->
<div id="products-table">
    <p>Click "Load products" to load products.</p>
</div>

<!-- ========== HTMX FRAGMENT ========== -->
<div th:fragment="table">
    <!-- Wrapper MUST include id="products-table" for outerHTML swap -->
    <div id="products-table">

        <!-- Show table ONLY when products is NOT empty -->
        <div th:if="${products != null and not #lists.isEmpty(products)}">

            <!-- Add form ABOVE the table -->
            <div class="add-form">
                <form id="add-product-form"
                      th:action="@{/products}"
                      method="post"
                      hx-post="/products"
                      hx-target="#products-table"
                      hx-swap="outerHTML">

                    <label>Title:
                        <input type="text" name="title" required/>
                    </label>

                    <label style="margin-left:20px;">Handle:
                        <input type="text" name="handle"/>
                    </label>

                    <button type="submit" style="margin-left:12px;">Add Product</button>
                </form>
            </div>

            <!-- The table itself -->
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Handle</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${products}" th:id="'row-' + ${p.id}">
                    <td th:text="${p.id}"></td>
                    <td th:text="${p.title}"></td>
                    <td th:text="${p.handle}"></td>
                    <td>
                        <a th:href="@{/products/{id}(id=${p.id})}">Update</a>
                        <!-- Delete button opens the confirmation dialog -->
                        <button type="button"
                                class="delete-btn"
                                th:attr="data-id=${p.id}, data-title=${p.title}"
                                onclick="openDeleteDialog(this)">
                            Delete
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>

        </div>

        <!-- If products is empty â‡’ return EMPTY HTML (nothing visible) -->
        <div th:if="${products != null and #lists.isEmpty(products)}"></div>

    </div> <!-- /#products-table -->
</div> <!-- /fragment -->

<!-- Delete dialog -->
<dialog id="confirmDeleteDialog">
    <h3>Confirm Delete</h3>
    <p id="confirmDeleteMsg">Are you sure you want to delete this?</p>

    <div style="margin-top:12px;">
        <button type="button" onclick="closeDeleteDialog()">Cancel</button>
        <button id="confirmDeleteBtn" type="button">Delete</button>
    </div>
</dialog>

<script>
    // Reset add product form after successful table load
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        const target = evt.detail && evt.detail.target;
        if (target && target.id === 'products-table') {
            const form = document.getElementById('add-product-form');
            if (form) form.reset();
        }

        // after any swap, ensure table placeholder is present if tbody empty
        setTimeout(checkEmptyTable, 0);
    });

    function openDeleteDialog(btn) {
        const id = btn.getAttribute('data-id');
        const title = btn.getAttribute('data-title') || id;

        const dialog = document.getElementById('confirmDeleteDialog');
        const msg = document.getElementById('confirmDeleteMsg');
        const confirmBtn = document.getElementById('confirmDeleteBtn');

        msg.textContent = `Are you sure you want to delete product "${title}" (ID: ${id})?`;

        // Set attributes
        confirmBtn.setAttribute('data-delete-id', id);

        dialog.showModal();
    }

    function closeDeleteDialog() {
        const dialog = document.getElementById('confirmDeleteDialog');
        if (dialog) {
            try { dialog.close(); } catch(e) {}
        }
    }

    function checkEmptyTable() {
        const wrapper = document.getElementById('products-table');
        if (!wrapper) return;

        const tbody = wrapper.querySelector('table tbody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.setAttribute('colspan', '4');
            td.className = 'muted';
            td.textContent = 'No products available.';
            tr.appendChild(td);
            tbody.appendChild(tr);
        } else {
            rows.forEach(r => {
                const firstTd = r.querySelector('td');
                if (firstTd && firstTd.colSpan === 4 &&
                    firstTd.classList.contains('muted') &&
                    rows.length > 1) {
                    r.remove();
                }
            });
        }
    }

    // DELETE handler
    document.addEventListener('click', function(e) {
        const el = e.target;
        if (!el || el.id !== 'confirmDeleteBtn') return;

        e.preventDefault();
        e.stopPropagation();

        const id = el.getAttribute('data-delete-id');
        if (!id) {
            console.warn('No delete id found on confirm button.');
            return;
        }
        const url = `/products/${id}`;
        const rowSelector = `#row-${id}`;

        if (window.htmx && typeof htmx.ajax === 'function') {
            htmx.ajax('DELETE', url, {
                target: rowSelector,
                swap: 'outerHTML'
            });

            setTimeout(() => closeDeleteDialog(), 200);
            setTimeout(() => {
                setTimeout(checkEmptyTable, 200);
            }, 300);

            return;
        }

        fetch(url, { method: 'DELETE', credentials: 'same-origin' })
            .then(r => {
                if (r.ok) {
                    const row = document.querySelector(rowSelector);
                    if (row) row.remove();
                    closeDeleteDialog();
                    checkEmptyTable();
                } else {
                    r.text().then(text => {
                        alert('Delete failed: ' + r.status + '\n' + text);
                    });
                }
            })
            .catch(err => alert('Delete error: ' + err));
    });

    document.addEventListener('DOMContentLoaded', function() {
        checkEmptyTable();
    });
</script>
</body>
</html>
