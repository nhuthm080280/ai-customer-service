<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Admin — Products</title>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>

    <!-- ✅ Web Awesome Theme (includes Design Tokens) -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@awesome.me/webawesome@3.0.0/dist-cdn/styles/themes/default.css">

    <!-- ✅ Web Awesome Components Loader -->
    <script type="module"
            src="https://cdn.jsdelivr.net/npm/@awesome.me/webawesome@3.0.0/dist-cdn/webawesome.loader.js">
    </script>

    <!-- Global Admin CSS -->
    <link rel="stylesheet" th:href="@{/admin_styles.css}">
</head>
<body>

<div class="layout">
    <aside class="sidebar"
           th:replace="common/sidebar :: sidebar">
    </aside>

    <div class="content-wrap">
        <div class="topbar">
            <div><strong>Products</strong></div>
            <div class="muted">Admin</div>
        </div>
        <main class="page">
            <div class="card">
                <!-- Controls -->
                <div class="controls">
                    <!-- load first page explicitly -->
                    <wa-button id="load-btn"
                               onclick="htmx.ajax('GET','/products/list?page=0',{target:'#products-table',swap:'outerHTML'})">
                        Load products
                    </wa-button>
                    <wa-button onclick="window.location.href='/products/search'">Search</wa-button>
                </div>

                <!-- Table container -->
                <div id="products-table">
                    <p class="muted">Click "Load products" to load products.</p>
                </div>

                <!-- HTMX fragment (server returns this fragment) -->
                <div th:fragment="table">
                    <!-- Use th:with to normalise whether server returned a Page or a List.
                         If 'page' exists we use page.content as products and expose pagination metadata.
                         Otherwise we fallback to plain 'products' (no pagination) -->
                    <div th:with="realProducts=${page != null} ? ${page.content} : ${products},
                                  hasPage=${page != null},
                                  pageNum=${page != null} ? ${page.number} : 0,
                                  totalPages=${page != null} ? ${page.totalPages} : 0,
                                  pageSize=${page != null} ? ${page.size} : 0,
                                  totalElements=${page != null} ? ${page.totalElements} : 0">

                        <div id="products-table">
                            <div th:if="${realProducts != null and not #lists.isEmpty(realProducts)}">
                                <wa-card style="max-width:900px;">
                                    <!-- Add form above table -->
                                    <div class="wa-stack" style="gap:16px;">
                                        <form id="add-product-form"
                                              th:action="@{/products}"
                                              method="post"
                                              hx-post="/products"
                                              hx-target="#products-table"
                                              hx-swap="outerHTML">
                                            <div class="form-grid">
                                                <div class="wa-field">
                                                    <label for="title">Title</label>
                                                    <input id="title" name="title" type="text" required />
                                                </div>

                                                <div class="wa-field">
                                                    <label for="handle">Handle</label>
                                                    <input id="handle" name="handle" type="text" />
                                                </div>

                                                <div class="wa-field">
                                                    <label for="vendor">Vendor</label>
                                                    <input id="vendor" name="vendor" type="text" />
                                                </div>

                                                <div class="wa-field">
                                                    <label for="productType">Product Type</label>
                                                    <input id="productType" name="productType" type="text" />
                                                </div>
                                            </div>
                                            <!-- /.form-grid -->
                                            <!-- Submit -->
                                            <div class="actions">
                                                <wa-button type="submit" variant="neutral">Add Product</wa-button>
                                            </div>
                                        </form>

                                    </div>
                                </wa-card>

                                <div class="wa-table-wrapper">
                                    <table class="wa-table">
                                        <thead>
                                        <tr>
                                            <th style="width:140px">ID</th>
                                            <th>Title</th>
                                            <th>Handle</th>
                                            <th>Vendor</th>
                                            <th>Product Type</th>
                                            <th>Published At</th>
                                            <th>Created At</th>
                                            <th>Updated At</th>
                                            <th></th>
                                            <th></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="p : ${realProducts}" th:id="'row-' + ${p.id}">
                                            <td th:text="${p.id}"></td>
                                            <td th:text="${p.title}"></td>
                                            <td th:text="${p.handle}"></td>

                                            <td th:text="${p.vendor}">—</td>
                                            <td th:text="${p.productType}">—</td>

                                            <td th:text="${#temporals.format(p.publishedAt, 'yyyy-MM-dd HH:mm')}">—</td>
                                            <td th:text="${#temporals.format(p.createdAt, 'yyyy-MM-dd HH:mm')}">—</td>
                                            <td th:text="${#temporals.format(p.updatedAt, 'yyyy-MM-dd HH:mm')}">—</td>

                                            <td>
                                                <wa-button type="button" variant="success"
                                                           th:onclick="'window.location.href=\'/products/' + ${p.id} + '\';'">
                                                    Update
                                                </wa-button>

                                            </td>
                                            <td>
                                                <!-- Delete opens dialog -->
                                                <wa-button type="button" variant="danger"
                                                           style="margin-left:8px;background:#ef4444"
                                                           class="delete-btn"
                                                           th:attr="data-id=${p.id}, data-title=${p.title}"
                                                           onclick="openDeleteDialog(this)">
                                                    Delete
                                                </wa-button>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- PAGINATION (only shown when server returned a Page) -->
                                <div class="pagination" style="margin-top:12px;" th:if="${hasPage}">
                                    <div class="pagination-info" style="margin-bottom:6px;">
                                        <span class="muted">
                                            Showing page <strong th:text="${pageNum + 1}">1</strong>
                                            of <strong th:text="${totalPages}">1</strong>
                                            — <span th:text="${totalElements}">0</span> products
                                        </span>
                                    </div>

                                    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
                                        <!-- Previous -->
                                        <button
                                                th:attr="hx-get=@{|/products/list?page=${pageNum - 1}|}"
                                                hx-target="#products-table"
                                                hx-swap="outerHTML"
                                                th:disabled="${pageNum == 0}"
                                                th:classappend="${pageNum == 0} ? 'disabled'">
                                            ← Previous
                                        </button>

                                        <!-- First page shortcut -->
                                        <button
                                                th:if="${pageNum > 2}"
                                                th:attr="hx-get=@{|/products/list?page=0|}"
                                                hx-target="#products-table"
                                                hx-swap="outerHTML">
                                            1
                                        </button>

                                        <span th:if="${pageNum > 3}">…</span>

                                        <!-- Page window: show current-1, current, current+1 -->
                                        <button
                                                th:each="i : ${#numbers.sequence((pageNum - 1) >= 0 ? pageNum -1 : 0, (pageNum + 1) < totalPages ? pageNum + 1 : totalPages -1)}"
                                                th:text="${i + 1}"
                                                th:attr="hx-get=@{|/products/list?page=${i}|}"
                                                hx-target="#products-table"
                                                hx-swap="outerHTML"
                                                th:classappend="${i == pageNum} ? 'active'">
                                        </button>

                                        <span th:if="${pageNum < totalPages - 4}">…</span>

                                        <!-- Last page shortcut -->
                                        <button
                                                th:if="${pageNum < totalPages - 2}"
                                                th:attr="hx-get=@{|/products/list?page=${totalPages - 1}|}"
                                                hx-target="#products-table"
                                                hx-swap="outerHTML">
                                            <span th:text="${totalPages}">N</span>
                                        </button>

                                        <!-- Next -->
                                        <button
                                                th:attr="hx-get=@{|/products/list?page=${pageNum + 1}|}"
                                                hx-target="#products-table"
                                                hx-swap="outerHTML"
                                                th:disabled="${pageNum + 1 >= totalPages}"
                                                th:classappend="${pageNum + 1 >= totalPages} ? 'disabled'">
                                            Next →
                                        </button>

                                        <!-- Optional: Quick jump to page (works via hx-get) -->
                                        <label style="margin-left:12px;">
                                            Jump:
                                            <input type="number" min="1" th:attr="max=${totalPages}" id="jumpPageInput"
                                                   style="width:70px">
                                        </label>
                                        <button type="button" onclick="jumpToPage()">Go</button>
                                    </div>
                                </div>

                            </div>

                            <!-- If realProducts is empty ⇒ show placeholder -->
                            <div th:if="${realProducts != null and #lists.isEmpty(realProducts)}">
                                <div style="padding:16px;">
                                    <p class="muted">No products available.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /fragment -->

            </div> <!-- /card -->
        </main>
    </div>
</div>

<!-- Delete confirmation dialog (kept existing functionality) -->
<dialog id="confirmDeleteDialog">
    <h3>Confirm Delete</h3>
    <p id="confirmDeleteMsg">Are you sure you want to delete this?</p>
    <div style="margin-top:12px;">
        <wa-button onclick="closeDeleteDialog()">Cancel</wa-button>
        <wa-button id="confirmDeleteBtn" variant="danger">Delete</wa-button>
    </div>
</dialog>

<script>
    // Reset add product form after table is swapped in
    document.body.addEventListener('htmx:afterSwap', function (evt) {
        const target = evt.detail && evt.detail.target;
        if (target && target.id === 'products-table') {
            const form = document.getElementById('add-product-form');
            if (form) form.reset();
        }
        setTimeout(checkEmptyTable, 0);
    });

    function openDeleteDialog(btn) {
        const id = btn.getAttribute('data-id');
        const title = btn.getAttribute('data-title') || id;
        const dialog = document.getElementById('confirmDeleteDialog');
        const msg = document.getElementById('confirmDeleteMsg');
        const confirmBtn = document.getElementById('confirmDeleteBtn');

        msg.textContent = `Are you sure you want to delete product "${title}" (ID: ${id})?`;
        confirmBtn.setAttribute('data-delete-id', id);
        dialog.showModal();
    }

    function closeDeleteDialog() {
        const dialog = document.getElementById('confirmDeleteDialog');
        if (dialog) {
            try {
                dialog.close();
            } catch (e) {
            }
        }
    }

    function checkEmptyTable() {
        const wrapper = document.getElementById('products-table');
        if (!wrapper) return;
        const tbody = wrapper.querySelector('table tbody');
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr'));
        // If no real rows, insert a placeholder row
        if (rows.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.setAttribute('colspan', '4');
            td.className = 'muted';
            td.textContent = 'No products available.';
            tr.appendChild(td);
            tbody.appendChild(tr);
        } else {
            // remove placeholder if extra real rows exist
            rows.forEach(r => {
                const firstTd = r.querySelector('td');
                if (firstTd && firstTd.colSpan === 4 && firstTd.classList.contains('muted') && rows.length > 1) {
                    r.remove();
                }
            });
        }
    }

    // Delete confirm handler: prefer HTMX, fallback to fetch()
    document.addEventListener('click', function (e) {
        const el = e.target;
        if (!el || el.id !== 'confirmDeleteBtn') return;

        e.preventDefault();
        e.stopPropagation();
        const id = el.getAttribute('data-delete-id');
        if (!id) return;
        const url = `/products/${id}`;
        const rowSelector = `#row-${id}`;

        if (window.htmx && typeof htmx.ajax === 'function') {
            htmx.ajax('DELETE', url, {target: rowSelector, swap: 'outerHTML'});
            setTimeout(() => closeDeleteDialog(), 200);
            setTimeout(() => {
                setTimeout(checkEmptyTable, 200);
            }, 300);
            return;
        }

        // fallback
        fetch(url, {method: 'DELETE', credentials: 'same-origin'})
            .then(r => {
                if (r.ok) {
                    document.querySelector(rowSelector)?.remove();
                    closeDeleteDialog();
                    checkEmptyTable();
                } else {
                    r.text().then(text => alert('Delete failed: ' + r.status + '\n' + text));
                }
            })
            .catch(err => alert('Delete error: ' + err));
    });

    document.addEventListener('DOMContentLoaded', function () {
        checkEmptyTable();
    });

    // Jump to page handler uses HTMX to request the target page
    function jumpToPage() {
        const input = document.getElementById('jumpPageInput');
        if (!input) return;
        let v = parseInt(input.value, 10);
        if (!v || v < 1) return;
        // pages in server are 0-based
        const page = v - 1;
        // Request with hx via JS (so we can construct URL)
        if (window.htmx) {
            htmx.ajax('GET', `/products/list?page=${page}`, {target: '#products-table', swap: 'outerHTML'});
        } else {
            // fallback: location
            window.location.href = `/products/list?page=${page}`;
        }
    }
</script>

</body>
</html>
